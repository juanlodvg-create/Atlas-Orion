<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atlas Orion | V10 Full Metrics</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono&display=swap');
        :root {
            --google-blue: #1a73e8;
            --google-green: #1e8e3e;
            --google-red: #d93025;
            --gradient-pro: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 100px; font-size: 11px; }
        .dashboard-header { background: var(--gradient-pro); color: white; padding: 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; }
        .save-status { position: absolute; top: 10px; right: 20px; font-size: 9px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; }
        .card-container { background: white; margin: -15px 10px 0 10px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #f8fafc; padding: 12px 6px; text-transform: uppercase; font-weight: 800; color: #475569; border-bottom: 2px solid #e2e8f0; font-size: 10px; }
        td { padding: 10px 6px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        td[contenteditable="true"] { background: #fff; font-family: 'Roboto Mono'; font-weight: 600; color: var(--google-blue); border: 1px solid #e2e8f0; border-radius: 4px; }
        .bar-container { height: 5px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 3px; min-width: 40px; }
        .bar-fill { height: 100%; transition: width 0.5s; }
        .tabs-container { display: flex; gap: 6px; padding: 15px; overflow-x: auto; justify-content: center; }
        .tab-chip { padding: 8px 14px; background: white; border-radius: 10px; border: 1px solid #e2e8f0; cursor: pointer; font-size: 11px; font-weight: 700; color: #64748b; }
        .tab-chip.active { background: var(--google-blue); color: white; border-color: var(--google-blue); }
        .bottom-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: #0f172a; padding: 12px 30px; border-radius: 50px; display: flex; gap: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); z-index: 100; }
        .fab-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div id="save-indicator" class="save-status">‚òÅÔ∏è Cargando Base de Datos...</div>
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <div style="font-size: 22px; font-weight: 800; letter-spacing: -1px;">Atlas Orion <span style="font-weight: 300; opacity: 0.6;">V10</span></div>
                <div id="current-date-display" style="opacity: 0.7; font-size: 11px;">-- / -- / ----</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 9px; opacity: 0.6;">CIERRE ESTIMADO</div>
                <div id="lbl-proyeccion" style="font-size: 18px; font-weight: 800; color: #4ade80;">$0</div>
            </div>
        </div>
    </div>

    <div class="tabs-container" id="tabsHorarios">
        <div class="tab-chip active" onclick="setTurno('14:00')">14:00</div>
        <div class="tab-chip" onclick="setTurno('16:00')">16:00</div>
        <div class="tab-chip" onclick="setTurno('18:00')">18:00</div>
        <div class="tab-chip" onclick="setTurno('20:00')">20:00</div>
        <div class="tab-chip" onclick="setTurno('Cierre')">CIERRE</div>
    </div>

    <div class="card-container">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="text-align: left; padding-left: 15px;">Unidad</th>
                        <th>Venta</th>
                        <th>Alcance</th>
                        <th>Tur</th>
                        <th>Vta</th>
                        <th>Conv%</th>
                        <th>Col</th>
                        <th>Gar</th>
                        <th>Mix%</th>
                        <th>Sea</th>
                        <th>Mag</th>
                        <th>Cot</th>
                        <th>QR</th>
                        <th>QR%</th>
                        <th>üö´</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="fab-btn" onclick="generarWhatsapp()">üí¨</button>
        <button class="fab-btn" onclick="exportImage()">üì∏</button>
        <button class="fab-btn" style="filter: brightness(1.5);" onclick="resetDay()">üóëÔ∏è</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwtFdVdUqAYtbV4ze6rJQRJlxU0y8gRos",
            authDomain: "atlas-orion.firebaseapp.com",
            projectId: "atlas-orion",
            storageBucket: "atlas-orion.firebasestorage.app",
            messagingSenderId: "267035487132",
            appId: "1:267035487132:web:041b2b711c9e743fa4b659",
            measurementId: "G-SZSN7X4B14"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA CENTRAL ---
        const TIENDAS_BASE = [
            { name: "Cuautitl√°n", quota: 65000 }, { name: "Naucalpan", quota: 35000 },
            { name: "Puente de Vigas", quota: 15000 }, { name: "Cuitl√°huac", quota: 25000 },
            { name: "San Marcos", quota: 20000 }, { name: "El Rosario", quota: 35000 },
            { name: "Santa M√≥nica", quota: 15000 }, { name: "Arboledas", quota: 15000 },
            { name: "Gran Terraza", quota: 15000 }, { name: "Plaza Tlalne", quota: 30000 },
            { name: "Santa Fe", quota: 30000 }, { name: "Paseo Interlomas", quota: 20000 },
            { name: "La C√∫spide", quota: 20000 }, { name: "San Miguel", quota: 15000 },
            { name: "Outlet", quota: 6000 }
        ];

        const HORARIOS = ['14:00', '16:00', '18:00', '20:00', 'Cierre'];
        let fullHistory = {};   
        let currentDateKey = new Date().toISOString().split('T')[0];
        let currentTurno = '14:00';
        let saveTimeout;

        // Inyectar funciones al objeto global para que los botones funcionen
        window.setTurno = (nuevo) => {
            currentTurno = nuevo;
            document.querySelectorAll('.tab-chip').forEach(c => {
                c.classList.remove('active');
                if(c.innerText === nuevo) c.classList.add('active');
            });
            render();
        };

        window.liveUpdate = (el, tienda, field) => {
            let val = parseFloat(el.innerText.replace(/[^0-9.-]/g, '')) || 0;
            fullHistory[currentDateKey][currentTurno][tienda][field] = val;
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                document.getElementById('save-indicator').innerText = "‚è≥ Guardando...";
                await setDoc(doc(db, "history", currentDateKey), fullHistory[currentDateKey]);
                document.getElementById('save-indicator').innerText = "‚úÖ Sincronizado";
                updateGlobalTotal();
            }, 1000);
        };

        window.toggleReport = async (tienda) => {
            fullHistory[currentDateKey][currentTurno][tienda].sinReporte = !fullHistory[currentDateKey][currentTurno][tienda].sinReporte;
            render();
            await setDoc(doc(db, "history", currentDateKey), fullHistory[currentDateKey]);
        };

        window.resetDay = async () => {
            if(confirm("¬øBorrar todo hoy?")) {
                createNewDay(currentDateKey);
            }
        };

        // --- MOTOR DE RENDERIZADO ---
        function render() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ''; 
            const data = fullHistory[currentDateKey][currentTurno];

            TIENDAS_BASE.forEach(t => {
                const d = data[t.name];
                const tr = document.createElement('tr');
                if(d.sinReporte) tr.style.backgroundColor = "#fff1f2";

                const alc = (d.monto/d.cuota)*100;
                const conv = (d.pedidos/Math.max(d.turnos,1))*100;
                const mix = (d.garant/Math.max(d.colch,1))*100;
                const pqr = (d.qr/Math.max(d.pedidos,1))*100;

                tr.innerHTML = `
                    <td style="text-align:left; padding-left:15px; font-weight:800;">${t.name}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'monto')">${d.monto}</td>
                    <td>${renderBar(alc, 100)}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'turnos')">${d.turnos}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'pedidos')">${d.pedidos}</td>
                    <td>${renderBar(conv, 25)}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'colch')">${d.colch}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'garant')">${d.garant}</td>
                    <td>${renderBar(mix, 30)}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'sealy')">${d.sealy || 0}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'magnus')">${d.magnus || 0}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'cotiz')">${d.cotiz}</td>
                    <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'qr')">${d.qr}</td>
                    <td>${renderBar(pqr, 50)}</td>
                    <td><input type="checkbox" ${d.sinReporte?'checked':''} onchange="toggleReport('${t.name}')"></td>
                `;
                tbody.appendChild(tr);
            });
            updateGlobalTotal();
        }

        function renderBar(pct, goal) {
            let color = pct >= goal ? 'var(--google-green)' : (pct > goal*0.7 ? '#f9bc05' : 'var(--google-red)');
            return `<div style="font-size:8px; font-weight:bold;">${Math.round(pct)}%</div>
                    <div class="bar-container"><div class="bar-fill" style="width:${Math.min(pct,100)}%; background:${color};"></div></div>`;
        }

        function updateGlobalTotal() {
            let total = 0;
            const data = fullHistory[currentDateKey][currentTurno];
            TIENDAS_BASE.forEach(t => total += data[t.name].monto);
            document.getElementById('lbl-proyeccion').innerText = '$' + Math.round(total).toLocaleString();
        }

        // --- CONEXI√ìN FIREBASE ---
        async function init() {
            document.getElementById('current-date-display').innerText = currentDateKey;
            const docRef = doc(db, "history", currentDateKey);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    fullHistory[currentDateKey] = docSnap.data();
                    document.getElementById('save-indicator').innerText = "‚òÅÔ∏è Online";
                    render();
                } else {
                    createNewDay(currentDateKey);
                }
            });
        }

        function createNewDay(dateKey) {
            fullHistory[dateKey] = {};
            HORARIOS.forEach(h => {
                fullHistory[dateKey][h] = {};
                TIENDAS_BASE.forEach(t => {
                    fullHistory[dateKey][h][t.name] = { 
                        monto: 0, cuota: t.quota, turnos: 0, pedidos: 0, 
                        colch: 0, garant: 0, sealy: 0, magnus: 0, cotiz: 0, qr: 0, sinReporte: false 
                    };
                });
            });
            setDoc(doc(db, "history", dateKey), fullHistory[dateKey]);
        }

        init();
    </script>

    <script>
        // Funciones de utilidad que no requieren Firebase
        function generarWhatsapp() {
            alert("Resumen copiado al portapapeles (Simulado)");
            // Aqu√≠ puedes pegar tu l√≥gica de texto de Whatsapp
        }
        function exportImage() {
            html2canvas(document.body).then(canvas => {
                let link = document.createElement('a');
                link.download = 'Reporte_Atlas.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>