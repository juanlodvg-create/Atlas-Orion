<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atlas Orion | V10 Cloud</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwtFdVdUqAYtbV4ze6rJQRJlxU0y8gRos",
            authDomain: "atlas-orion.firebaseapp.com",
            projectId: "atlas-orion",
            storageBucket: "atlas-orion.firebasestorage.app",
            messagingSenderId: "267035487132",
            appId: "1:267035487132:web:041b2b711c9e743fa4b659",
            measurementId: "G-SZSN7X4B14"
        };

        // Inicializaci√≥n Global
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Exponer a Window para que las funciones fuera del m√≥dulo funcionen
        window.db = db;
        window.fs = { doc, setDoc, getDoc, onSnapshot };
        
        console.log("üî• Firebase Conectado a Atlas-Orion");
        // Iniciar la app despu√©s de que Firebase est√© listo
        if (window.initApp) window.initApp();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono&display=swap');
        :root {
            --google-blue: #1a73e8;
            --google-green: #1e8e3e;
            --google-red: #d93025;
            --gradient-pro: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .dashboard-header { background: var(--gradient-pro); color: white; padding: 25px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: relative; }
        .save-status { position: absolute; top: 15px; right: 20px; font-size: 10px; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        .card-container { background: white; margin: -20px 15px 0 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8fafc; padding: 15px 8px; text-transform: uppercase; font-weight: 700; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        td[contenteditable="true"] { background: #fdfdfd; font-family: 'Roboto Mono'; font-weight: 600; color: var(--google-blue); border: 1px dashed #d1d5db; }
        .bar-container { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.5s; }
        .tabs-container { display: flex; gap: 8px; padding: 15px; overflow-x: auto; justify-content: center; }
        .tab-chip { padding: 8px 16px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; font-size: 12px; font-weight: 600; }
        .tab-chip.active { background: var(--google-blue); color: white; border-color: var(--google-blue); }
        .bottom-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: #1e293b; padding: 10px 25px; border-radius: 30px; display: flex; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .fab-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div id="save-indicator" class="save-status">‚òÅÔ∏è Conectando...</div>
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <div style="font-size: 24px; font-weight: 800;">Atlas Orion</div>
                <div style="opacity: 0.7; font-size: 12px;">Gesti√≥n de M√©tricas Inteligentes</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 10px; opacity: 0.6;">VENTA TOTAL ZONA</div>
                <div id="lbl-proyeccion" style="font-size: 20px; font-weight: 800; color: #4ade80;">$0</div>
            </div>
        </div>
    </div>

    <div class="tabs-container" id="tabsHorarios">
        <div class="tab-chip active" onclick="setTurno('14:00')">14:00</div>
        <div class="tab-chip" onclick="setTurno('16:00')">16:00</div>
        <div class="tab-chip" onclick="setTurno('18:00')">18:00</div>
        <div class="tab-chip" onclick="setTurno('20:00')">20:00</div>
        <div class="tab-chip" onclick="setTurno('Cierre')">CIERRE</div>
    </div>

    <div class="card-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th style="text-align: left; padding-left: 15px;">Tienda</th>
                    <th>Venta</th>
                    <th>Alcance</th>
                    <th>Conv</th>
                    <th>Mix Gar</th>
                    <th>QR%</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="bottom-bar">
        <button class="fab-btn" onclick="generarWhatsapp()">üí¨</button>
        <button class="fab-btn" onclick="exportImage()">üì∏</button>
        <button class="fab-btn" style="filter: hue-rotate(140deg);" onclick="resetDay()">üóëÔ∏è</button>
    </div>

<script>
    const TIENDAS_BASE = [
        { name: "Cuautitl√°n", quota: 65000 }, { name: "Naucalpan", quota: 35000 },
        { name: "Puente de Vigas", quota: 15000 }, { name: "Cuitl√°huac", quota: 25000 },
        { name: "San Marcos", quota: 20000 }, { name: "El Rosario", quota: 35000 },
        { name: "Santa M√≥nica", quota: 15000 }, { name: "Arboledas", quota: 15000 },
        { name: "Gran Terraza", quota: 15000 }, { name: "Plaza Tlalne", quota: 30000 },
        { name: "Santa Fe", quota: 30000 }, { name: "Paseo Interlomas", quota: 20000 },
        { name: "La C√∫spide", quota: 20000 }, { name: "San Miguel", quota: 15000 },
        { name: "Outlet", quota: 6000 }
    ];

    const HORARIOS = ['14:00', '16:00', '18:00', '20:00', 'Cierre'];
    let fullHistory = {};   
    let currentDateKey = new Date().toISOString().split('T')[0]; 
    let currentTurno = '14:00';
    let saveTimeout;

    window.initApp = async function() {
        console.log("Iniciando componentes...");
        syncWithCloud(currentDateKey);
    };

    function syncWithCloud(dateKey) {
        const docRef = window.fs.doc(window.db, "history", dateKey);
        window.fs.onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                fullHistory[dateKey] = docSnap.data();
                document.getElementById('save-indicator').innerText = "‚òÅÔ∏è Online";
                render();
            } else {
                createNewDay(dateKey);
            }
        });
    }

    async function saveToCloud() {
        document.getElementById('save-indicator').innerText = "‚è≥ Guardando...";
        const docRef = window.fs.doc(window.db, "history", currentDateKey);
        await window.fs.setDoc(docRef, fullHistory[currentDateKey]);
        document.getElementById('save-indicator').innerText = "‚úÖ Sincronizado";
    }

    function createNewDay(dateKey) {
        fullHistory[dateKey] = {};
        HORARIOS.forEach(h => {
            fullHistory[dateKey][h] = {};
            TIENDAS_BASE.forEach(t => {
                fullHistory[dateKey][h][t.name] = { monto: 0, cuota: t.quota, turnos: 0, pedidos: 0, garant: 0, colch: 0, qr: 0 };
            });
        });
        saveToCloud();
    }

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; 
        const data = fullHistory[currentDateKey][currentTurno];
        let totalVenta = 0;

        TIENDAS_BASE.forEach(t => {
            const d = data[t.name];
            totalVenta += d.monto;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align: left; padding-left: 15px; font-weight: 600;">${t.name}</td>
                <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'monto')">${d.monto}</td>
                <td>${renderBar( (d.monto/d.cuota)*100, 100)}</td>
                <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'pedidos')">${d.pedidos}</td>
                <td>${renderBar( (d.garant/Math.max(d.pedidos,1))*100, 30)}</td>
                <td contenteditable="true" oninput="liveUpdate(this, '${t.name}', 'qr')">${d.qr}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('lbl-proyeccion').innerText = '$' + totalVenta.toLocaleString();
    }

    function liveUpdate(el, tienda, field) {
        let val = parseFloat(el.innerText) || 0;
        fullHistory[currentDateKey][currentTurno][tienda][field] = val;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveToCloud, 1000);
    }

    function renderBar(pct, goal) {
        const color = pct >= goal ? 'var(--google-green)' : (pct > goal*0.6 ? '#f9bc05' : 'var(--google-red)');
        return `<div style="font-size:9px; font-weight:bold;">${Math.round(pct)}%</div>
                <div class="bar-container"><div class="bar-fill" style="width:${Math.min(pct,100)}%; background:${color};"></div></div>`;
    }

    function setTurno(nuevo) {
        currentTurno = nuevo;
        document.querySelectorAll('.tab-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        render();
    }

    function resetDay() {
        if(confirm("¬øReiniciar datos de hoy?")) createNewDay(currentDateKey);
    }
</script>
</body>
</html>